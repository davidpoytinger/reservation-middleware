<!-- charge-tool.html (ONLY the JS section needs updates) -->
<script>
  // ============================
  // CONFIG
  // ============================
  const ADMIN_CHARGE_KEY = "BR_CHARGE_9sj3k2h29sjdksu832kxnvgq930qa";
  const API_URL = "/api/charge-adjustment";

  const params = new URLSearchParams(location.search);
  const IDKEY = (params.get("IDKEY") || params.get("idkey") || "").trim();

  const idkeyMsg = document.getElementById("idkeyMsg");
  const statusEl = document.getElementById("status");
  const chargeBtn = document.getElementById("chargeBtn");

  function show(kind, msg) {
    statusEl.className = "status " + kind;
    statusEl.style.display = "block";
    statusEl.textContent = msg;
  }

  function num(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function round2(n) {
    return Math.round(n * 100) / 100;
  }

  function compute() {
    const base = num(document.getElementById("base").value);
    const taxPct = num(document.getElementById("tax").value || 6.1);
    const gratPct = num(document.getElementById("grat").value || 15);

    const tax = round2(base * (taxPct / 100));
    const grat = round2(base * (gratPct / 100));
    const total = round2(base + tax + grat);

    document.getElementById("totals").innerHTML = `
      <div class="line"><span>Base</span><span>$${base.toFixed(2)}</span></div>
      <div class="line"><span>Tax (${taxPct.toFixed(2)}%)</span><span>$${tax.toFixed(2)}</span></div>
      <div class="line"><span>Auto Grat (${gratPct.toFixed(2)}%)</span><span>$${grat.toFixed(2)}</span></div>
      <div style="border-top:1px solid #eee; margin-top:8px; padding-top:8px;"></div>
      <div class="line"><strong>Total</strong><strong>$${total.toFixed(2)}</strong></div>
    `;

    return { base, taxPct, gratPct, tax, grat, total };
  }

  ["base", "tax", "grat"].forEach((id) => document.getElementById(id).addEventListener("input", compute));

  if (IDKEY) idkeyMsg.textContent = "IDKEY: " + IDKEY;
  else idkeyMsg.textContent = "⚠ Missing IDKEY in URL (add ?IDKEY=XXXX).";

  compute();

  function showSuccessAndClose() {
    show("ok", "✅ Charge Successful\n\nRefreshing parent page…");
    setTimeout(() => {
      try {
        window.parent.postMessage({ type: "BAR_CHARGE_DONE" }, "*");
      } catch (e) {}
      try {
        document.body.innerHTML = "";
      } catch (e) {}
    }, 900);
  }

  async function readResponseAny(resp) {
    const ct = (resp.headers.get("content-type") || "").toLowerCase();
    const text = await resp.text().catch(() => "");
    let json = null;
    if (ct.includes("application/json")) {
      try {
        json = JSON.parse(text);
      } catch (e) {
        json = null;
      }
    } else {
      try {
        json = JSON.parse(text);
      } catch (e) {
        json = null;
      }
    }
    return { text, json };
  }

  chargeBtn.addEventListener("click", async () => {
    if (!IDKEY) return show("bad", "Missing IDKEY in URL.");

    const description = (document.getElementById("desc").value || "").trim();
    if (!description) return show("bad", "Description is required.");

    const c = compute();
    if (!c.base || c.base <= 0) return show("bad", "Base must be greater than 0.");

    const payload = {
      idkey: IDKEY,
      type: document.getElementById("type").value,
      why: (document.getElementById("reason").value || "").trim(),
      base_amount: c.base,
      tax_pct: c.taxPct,
      grat_pct: c.gratPct,
    };
    payload.why = description + (payload.why ? " — " + payload.why : "");

    chargeBtn.disabled = true;
    show("warn", "Processing…");

    try {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-charge-key": ADMIN_CHARGE_KEY,
        },
        body: JSON.stringify(payload),
      });

      const { text, json } = await readResponseAny(resp);

      if (!resp.ok) {
        const msg = json ? (json.error || JSON.stringify(json, null, 2)) : text || ("HTTP " + resp.status);
        show("bad", msg);
        chargeBtn.disabled = false;
        return;
      }

      // ✅ If backend says checkout fallback, go to Stripe checkout
      if (json && json.ok && json.mode === "checkout" && json.checkout_url) {
        window.location.href = json.checkout_url;
        return;
      }

      if (json && json.ok) {
        showSuccessAndClose();
        return;
      }

      show("ok", (json ? JSON.stringify(json, null, 2) : text) || "SUCCESS");
      showSuccessAndClose();
    } catch (e) {
      show("bad", "Failed: " + (e?.message || String(e)));
      chargeBtn.disabled = false;
    }
  });
</script>
